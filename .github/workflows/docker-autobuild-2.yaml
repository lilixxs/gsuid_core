# è‡ªåŠ¨æž„å»º docker é•œåƒ
name: Docker Build and Compose -> Alibaba ACR

# å‚æ•°é…ç½®ä¸ºçŽ¯å¢ƒå˜é‡
env:
  # tag_prefix è½¯ä»¶åŒ…åç§°ï¼Œé€šå¸¸ä¸º docker hub ç”¨æˆ·å/è½¯ä»¶åŒ…åç§°
  # tag_version docker åŒ…ç‰ˆæœ¬ï¼ŒåŽç»­è¦å®žçŽ°è‡ªåŠ¨æ‰“ï¼ˆå¯èƒ½å¾—åŠ  actions é‡Œè¾¹çš„æ’ä»¶ï¼‰
  # dockerfile_path Dockerfile è·¯å¾„
  # build_branch æž„å»ºåˆ†æ”¯
  tag_prefix: "lilixxs666/gsuid-core"
  tag_version: "dev"
  dockerfile_path: "Dockerfile"
  build_branch: "master"
  # å…¶ä»–è¦æŒ‡å®šçš„å˜é‡ DOCKER_USERNAME å’Œ DOCKER_PASSWORD éœ€è¦åœ¨ä»“åº“çš„ è®¾ç½® --> secrets é‡Œè¾¹é…ç½®
  # DOCKER_USERNAME = docker hub ç”¨æˆ·å
  # DOCKER_PASSWORD = docker hub å¯†ç 

on:
  # å®šæ—¶æ‰§è¡Œï¼šæ¯åŠå¤©ï¼ˆ12å°æ—¶ï¼‰æ‰§è¡Œä¸€æ¬¡
  # schedule:
  #   - cron:  '0 */12 * * *'
  # æŒ‰é”®æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      need_push:
        description: 'æ˜¯å¦æŽ¨é€åˆ°dockerhub...'
        type: boolean
        default: true


jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.build_branch }}


      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create Docker meta
        id: docker_img_meta
        uses: docker/metadata-action@v5
        with:
          # list of Docker images to use as base name for tags
          images: |
            ${{ env.tag_prefix }},enable=true
          # generate Docker tags based on the following events/attributes
          tags: |
            type=raw,value=dev-{{date 'YYYYMMDD'}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          push: ${{ env.need_push == true }}
          tags: |
            ${{ steps.docker_img_meta.outputs.tags }}


      - name: prepare messages for feishu sending
        run: |
          echo "
          msg_type: post
          content:
            post:
              zh_cn:
                title: ðŸ¤– Github CI/CD ç»“æžœ
                content:
                - - tag: text
                    text: 'å·¥ä½œæµï¼š'
                  - tag: text
                    text: ${{ github.workflow }}
                - - tag: text
                    text: 'ä»“åº“ï¼š'
                  - tag: text
                    text: ${{ github.repository }}
                - - tag: text
                    text: 'è§¦å‘äº‹ä»¶ï¼š'
                  - tag: text
                    text: ${{ github.event_name }}
                - - tag: text
                    text: '--------------------------'
                - - tag: text
                    text: 'æ‰§è¡Œç»“æžœ'
                  - tag: text
                    text: ${{ github.action_status }}
          " > msg.yaml
          echo msg.yaml

      - name: convert msg from yaml to json
        run: |
          wget https://github.com/mikefarah/yq/releases/download/v4.16.2/yq_linux_amd64 \
          && chmod +x yq_linux_amd64 \
          && mv yq_linux_amd64 /usr/local/bin/yq
          yq eval -o json msg.yaml |tee msg.json
          echo "MSG_JSON=$(cat msg.json)" >> $GITHUB_ENV

      - name: send messages to feishu
        uses: Rollingegg/feishu-robot-action@v1
        with:
          version: 2
          uuid: ${{ secrets.FEISHU_BOT_WEBSOCKET_ENDPOINT }}
          secret: ${{ secrets.FEISHU_BOT_AUTHKEY }}
          json: |
            ${{ env.MSG_JSON }}

