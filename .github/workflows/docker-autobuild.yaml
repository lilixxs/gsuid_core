# è‡ªåŠ¨æž„å»º docker é•œåƒ
name: Docker Build and Compose

# å‚æ•°é…ç½®ä¸ºçŽ¯å¢ƒå˜é‡
env:
  # tag_prefix è½¯ä»¶åŒ…åç§°ï¼Œé€šå¸¸ä¸º docker hub ç”¨æˆ·å/è½¯ä»¶åŒ…åç§°
  # tag_version docker åŒ…ç‰ˆæœ¬ï¼ŒåŽç»­è¦å®žçŽ°è‡ªåŠ¨æ‰“ï¼ˆå¯èƒ½å¾—åŠ  actions é‡Œè¾¹çš„æ’ä»¶ï¼‰
  # dockerfile_path Dockerfile è·¯å¾„
  # build_branch æž„å»ºåˆ†æ”¯
  tag_prefix: "lilixxs666/gsuid-core"
  tag_version: "dev"
  dockerfile_path: "Dockerfile"
  build_branch: "master"
  # å…¶ä»–è¦æŒ‡å®šçš„å˜é‡ DOCKER_USERNAME å’Œ DOCKER_PASSWORD éœ€è¦åœ¨ä»“åº“çš„ è®¾ç½® --> secrets é‡Œè¾¹é…ç½®
  # DOCKER_USERNAME = docker hub ç”¨æˆ·å
  # DOCKER_PASSWORD = docker hub å¯†ç 

on:
  # docker-autobuild åˆ†æ”¯ push äº‹ä»¶è§¦å‘
  # push:
  #   branches:
  #     - docker-autobuild
  # å®šæ—¶æ‰§è¡Œï¼šæ¯åŠå¤©ï¼ˆ12å°æ—¶ï¼‰æ‰§è¡Œä¸€æ¬¡
  schedule:
    - cron:  '0 */12 * * *'
  # æ‰‹åŠ¨è„šæœ¬
  workflow_dispatch:
    inputs:
      sync_test_mode:
        description: 'ä»…æµ‹è¯•è¾“å‡º... | Manual Mode...'
        type: boolean
        default: false


jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout the repository
      uses: actions/checkout@v2
      with:
        ref: ${{ env.build_branch }}

    - name: Set up Docker
      uses: docker/setup-buildx-action@v2

    - name: Install Docker and Docker Compose
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          apt-transport-https \
          ca-certificates \
          curl \
          gnupg \
          lsb-release
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
        echo \
          "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
          $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
        sudo apt-get update
        sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
        sudo systemctl start docker
        sudo systemctl enable docker

    - name: Show current files
      run: |
        echo "pwd = $(pwd)"
        echo -------- ls -al --------------
        ls -al
        echo ------------------------------

    # ä¸éœ€è¦æ‰‹åŠ¨cloneï¼Œactions/checkout@v2 å·²ç»è‡ªåŠ¨ clone äº†
    # - name: Clone gsuid-core repository && branch
    #   run: |
    #     git clone -b master https://github.com/Genshin-bots/gsuid_core.git --depth=1 --single-branch
    #     ls -al
    #     chmod 777 -R gsuid_core

    - name: åŸºç¡€æ’ä»¶å®‰è£… (GenshinUID) | Clone GenshinUID plugin (v4)
      run: |
        echo "pwd = $(pwd)"
        echo -------- ls -al --------------
        ls -al
        echo -----------------------------
        [ -d ./gsuid_core/plugins ] && echo "plugin path exists, contine..." || mkdir -p ./gsuid_core/plugins
        cd ./gsuid_core/plugins
        git clone -b v4 https://github.com/KimigaiiWuyi/GenshinUID.git --depth=1 --single-branch

    - name: login docker hub
      run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

    - name: build & tag images
      run: |
        echo "pwd = $(pwd)"
        echo -------- ls -al --------------
        ls -al
        echo -----------------------------
        docker build -t ${{ env.tag_prefix }}:${{ env.tag_version }} -f ${{ env.dockerfile_path }} .
        docker images

    - name: export docker image
      run: |
        echo "pwd = $(pwd)"
        echo -------- ls -al --------------
        ls -al
        echo -----------------------------
        docker save -o gsuid-core.tar ${{ env.tag_prefix }}:${{ env.tag_version }}

    - name: Push to Docker Hub
      if: ${{ inputs.sync_test_mode }} == false
      run: |
        docker push ${{ env.tag_prefix }}:${{ env.tag_version }}


    - name: Sending Feishu Message
      uses: x-actions/feishu@main
      env:
        FEISHU_CUSTOMERBOT_WEBHOOK: https://open.feishu.cn/open-apis/bot/v2/hook/${{ secrets.FEISHU_BOT_WEBSOCKET_ENDPOINT }}
        FEISHU_CUSTOMERBOT_SECRET: ${{ secrets.FEISHU_BOT_AUTHKEY }}
        MSGTYPE: text
        TITLE: "ðŸ¤– Github CI/CD ç»“æžœ"
        CONTENT: |
          > å·¥ä½œæµï¼š${{ github.workflow }}
          > ä»“åº“ï¼š${{ github.repository }}
          > è§¦å‘äº‹ä»¶ï¼š${{ github.event_name }}
          > ----------------------
          > æ‰§è¡Œç»“æžœï¼šOK-${{ github.action_status }}