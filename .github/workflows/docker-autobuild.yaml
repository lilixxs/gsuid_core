# è‡ªåŠ¨æž„å»º docker é•œåƒ
name: Docker Build -> gsuid-core

# å‚æ•°é…ç½®ä¸ºçŽ¯å¢ƒå˜é‡
env:
  # tag_prefix è½¯ä»¶åŒ…åç§°ï¼Œé€šå¸¸ä¸º docker hub ç”¨æˆ·å/è½¯ä»¶åŒ…åç§°
  # tag_version docker åŒ…ç‰ˆæœ¬ï¼ŒåŽç»­è¦å®žçŽ°è‡ªåŠ¨æ‰“ï¼ˆå¯èƒ½å¾—åŠ  actions é‡Œè¾¹çš„æ’ä»¶ï¼‰
  # dockerfile_path Dockerfile è·¯å¾„
  # build_branch æž„å»ºåˆ†æ”¯
  tag_prefix: "lilixxs666/gsuid-core"
  tag_version: "dev"
  dockerfile_path: "Dockerfile"
  build_branch: "master"
  # å…¶ä»–è¦æŒ‡å®šçš„å˜é‡ DOCKER_USERNAME å’Œ DOCKER_PASSWORD éœ€è¦åœ¨ä»“åº“çš„ è®¾ç½® --> secrets é‡Œè¾¹é…ç½®
  # DOCKER_USERNAME = docker hub ç”¨æˆ·å
  # DOCKER_PASSWORD = docker hub å¯†ç 

on:
  # docker-autobuild åˆ†æ”¯ push äº‹ä»¶è§¦å‘
  # push:
  #   branches:
  #     - docker-autobuild
  # å®šæ—¶æ‰§è¡Œï¼šæ¯åŠå¤©ï¼ˆ12å°æ—¶ï¼‰æ‰§è¡Œä¸€æ¬¡
  schedule:
    - cron:  '0 */12 * * *'
  # æ‰‹åŠ¨è„šæœ¬
  workflow_dispatch:
    inputs:
      test_no_compile:
        description: 'æµ‹è¯•ï¼Œä¸ç¼–è¯‘é•œåƒ... | Manual Mode...'
        type: boolean
        default: false
      test_no_push:
        description: 'æµ‹è¯•ï¼Œä¸å‘å¸ƒé•œåƒ... | Manual Mode...'
        type: boolean
        default: false


jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout the repository
      uses: actions/checkout@v2
      with:
        ref: ${{ env.build_branch }}

    - name: Set up Docker
      if: ${{ inputs.test_no_compile == false }}
      uses: docker/setup-buildx-action@v2

    - name: Install Docker and Docker Compose
      if: ${{ inputs.test_no_compile == false }}
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          apt-transport-https \
          ca-certificates \
          curl \
          gnupg \
          lsb-release
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
        echo \
          "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
          $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
        sudo apt-get update
        sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
        sudo systemctl start docker
        sudo systemctl enable docker

    - name: Show current files
      run: |
        echo "pwd = $(pwd)"
        echo -------- ls -al --------------
        ls -al
        echo ------------------------------

    # ä¸éœ€è¦æ‰‹åŠ¨cloneï¼Œactions/checkout@v2 å·²ç»è‡ªåŠ¨ clone äº†
    # - name: Clone gsuid-core repository && branch
    #   run: |
    #     git clone -b master https://github.com/Genshin-bots/gsuid_core.git --depth=1 --single-branch
    #     ls -al
    #     chmod 777 -R gsuid_core

    - name: åŸºç¡€æ’ä»¶å®‰è£… (GenshinUID) | Clone GenshinUID plugin (v4)
      run: |
        echo "pwd = $(pwd)"
        echo -------- ls -al --------------
        ls -al
        echo -----------------------------
        [ -d ./gsuid_core/plugins ] && echo "plugin path exists, contine..." || mkdir -p ./gsuid_core/plugins
        cd ./gsuid_core/plugins
        git clone -b v4 https://github.com/KimigaiiWuyi/GenshinUID.git --depth=1 --single-branch

    - name: login docker hub
      if: ${{ inputs.test_no_compile == false || inputs.test_no_push == false}}
      run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

    - name: build & tag images
      if: ${{ inputs.test_no_compile == false }}
      run: |
        echo "pwd = $(pwd)"
        echo -------- ls -al --------------
        ls -al
        echo -----------------------------
        docker build -t ${{ env.tag_prefix }}:${{ env.tag_version }} -f ${{ env.dockerfile_path }} .
        docker images

    - name: export docker image
      if: ${{ inputs.test_no_compile == false }}
      run: |
        echo "pwd = $(pwd)"
        echo -------- ls -al --------------
        ls -al
        echo -----------------------------
        docker save -o gsuid-core.tar ${{ env.tag_prefix }}:${{ env.tag_version }}

    - name: Push to Docker Hub
      if: ${{ inputs.test_no_push == false }}
      run: |
        docker push ${{ env.tag_prefix }}:${{ env.tag_version }}

    - name: prepare messages for feishu sending
      run: |
        echo "
        msg_type: post
        content:
          post:
            zh_cn:
              title: 'ðŸ¤– Github CI/CD ç»“æžœ'
              content:
              - - tag: text
                  text: 'å·¥ä½œæµï¼š'
                - tag: text
                  text: ${{ github.workflow }}
              - - tag: text
                  text: 'ä»“åº“ï¼š'
                - tag: text
                  text: ${{ github.repository }}
              - - tag: text
                  text: 'è§¦å‘äº‹ä»¶ï¼š'
                - tag: text
                  text: ${{ github.event_name }}
              - - tag: text
                  text: '--------------------------'
              - - tag: text
                  text: 'æ‰§è¡Œç»“æžœ'
                - tag: text
                  text: 'OK-${{ github.action_status }}'
        " > msg.yaml
        echo msg.yaml

    - name: convert msg from yaml to json (json flattern)
      run: |
        wget https://github.com/mikefarah/yq/releases/download/v4.16.2/yq_linux_amd64 \
        && chmod +x yq_linux_amd64 \
        && mv yq_linux_amd64 /usr/local/bin/yq
        yq eval -o json msg.yaml |tee msg.json
        sed ':a;N;$!ba;s/\n//g;s/[[:space:]]\+/ /g' msg.json > msg.json
        echo "MSG_JSON=$(cat msg.json)" >> $GITHUB_ENV

    - name: send messages to feishu -- Bot test
      uses: Rollingegg/feishu-robot-action@v1
      with:
        version: 2
        uuid: ${{ secrets.FEISHU_BOT_WEBSOCKET_ENDPOINT }}
        secret: ${{ secrets.FEISHU_BOT_AUTHKEY }}
        json: |
          "${{ env.MSG_JSON }}"